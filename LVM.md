# Работа с LVM, Файловые системы

Терминальные утилиты:
- fdisk
- cfdisk
- parted

Графические утилиты:
- Disks
- Gparted

Прочие:
- resize2fs # для изменения размера файловой системы

# Доп. команды:
```
df #информация о занятом месте на диске
	df -Th #показывает доступное место, выводит инфу о типе ФС, в human-readable формате

du #информация о занимаемом файлами месте на диске
	du -ahx . | sort -rh | head -5 #выводит топ 5 самых тяжелых файлов в текущей директории

blkid #информация об идентификаторах блочных устройств

lsblk #информация о блочных устройствах, но более информативно
	lsblk --all --output-all #максимум инфы

mkfs – создание файловой системы в разделе
```

# Популярные файловые системы
- FAT32
- NTFS
- EXT(2,3,4)
- XFS

# Работа с fdisk
```
fdisk /dev/sda
m #manual, справка
p #partitions, список разделов
F #FREE, неразмеченное пространство
n #new, новый раздел
w #write, записать изменения
q #quit, выход
```

# lsblk
Команда `lsblk` позволяет получить информацию о **блочных устройствах**. **Блочное устройство** — это термин для обозначения устройства хранения данных, которое считывает или записывает данные в блоках определенного размера. Этот термин относится почти к каждому типу энергонезависимой памяти, в том числе к жестким дискам (HDD), твердотельным накопителям (SSD), флэш-памяти и так далее.
Файл блочного устройства находится в директории /dev
```
ls -la /dev/sd* #выводит файлы sd*, где записи brw-rw---- символ b это обозначение блочного устройства

lsblk #выводит список всех блочных устройств
	lsblk -f #информация об используемых файловых системах
	lsblk /dev/sda #более подробная информация о диске
	#информация о uuid может быть полезна для настройки файла /etc/fstab
```

Пример файловой системы с дисками, разделами и LVM
sda - диск
	sda1, sda2, sda3, sdb1 - разделы
		vg_root-fs.swap, vg_root-fs.root - логические разделы LVM 

# LVM
**LVM** – Logical Volume Manager - это подсистема ядра Linux для распределения дискового пространства накопителей по логическам группам и томам, размер которых можно легко менять. Своего рода это виртуализация дисков

Работа с LVM происходит на трёх уровнях абстракции:
1. PV - Physical Volume - физические тома, логическое отображение накопителей внутри LVM. Могут быть диски целиком (/dev/sda) или конкретные разделы (/dev/sda1, /dev/sda2)
2. VG - Volume Group - логическая группа томов. Их названия обычно могут говорить об их назначении
3. LV - Logical Volume - логический том, на котором непосредственно создается ФС. По сути как изначальные разделы жестких дисков. Становится не важно с какими именно жесткими дисками работает пользователь 

# Заметки:
- Рекомендуется выносить на отдельные разделы определенные каталоги, как, например, /home, /var и прочие для хранения пользовательских данных, логов, бэкапов сервера и так далее
- LVM позволяет: 
	- использовать разные области одного жесткого диска и/или области с разных жестких дисков как один логический том, 
	- распределять место между логическими томами из общего пула (VG), 
	- изменять размеры - увеличивать/уменьшать логические тома с ФС по необходимости,
	- добавлять в систему и задействовать дополнительные разделы и/или накопители без переноса/переустановки и т.п. системы
	- выполнять работы "на лету" без перезагрузки/перемонтирования
	- выделять томам минимально необходимый размер и держать "горячий резерв"
- некоторые Linux-дистрибутивы могут создавать разделы LVM по-умолчанию. Лучше всего ставить LVM с самого начала
- **LVM это ОЧЕНЬ(!!!) мощный инструмент, который требует аккуратного с собой обращения. Любая самодеятельность с ним может обернуться потерей всей(!!!) информации на диске. Поэтому прежде, чем использовать LVM на рабочих машинах (и уж тем более на «боевых» серверах), следует потренироваться на кошках. Лучше всего это делать на виртуальных машинах. Начинать использовать LVM следует ТОЛЬКО (и только!!!) тогда, как почувствуете уверенность и понимание принципов его работы.**

# Установка LVM
```
sudo apt install lvm2
```

# Работа с LVM
```
pv
	pvs ИЛИ pvscan #список physical volumes 
	pvcreate
		pvcreate /dev/sdb1
	pvdisplay # подробная информация о pv
		pvdisplay /dev/sdb1
	pvremove #удаление pv

vg
	vgcreate 
		vgcreate myvg /dev/sdb1
	vgs #список volume groups
	vgdisplay
		vgdisplay myvg
	vgextend
		vgextend myvg /dev/sdc
	vgremove

lv
	lvs #список logical volumes 
	lvcreate
		lvcreate myvg -n mylv -l 100%FREE
		sudo mkfs.ext4 /dev/myvg/mylv
	lvdisplay
		lvdisplay myvg/mylv
	lvextend
		sudo lvextend myvg/mylv -L +500M
		sudo resize2fs /dev/myvg/mylv
		ИЛИ
		lvextend myvg/mylv -L +100M -r
	lvremove
	lvreduce
		lvreduce -r -L 50Gb /dev/vg0/var
		[Уменьшение размера LVM раздела в Centos](https://support.hitex.by/index.php?/Knowledgebase/Article/View/172)
```

# Пример настройки диска /dev/sdb
```
fdisk /dev/sda
n #создаем новый раздел
+2G #увеличиваем на 2Гб
t #меняем на типа раздела на LVM
30
w #записываем изменения

pvcreate /dev/sda4
vgextend vgubuntu /dev/sda4
lvextend -L +1G /dev/vgubuntu/root /dev/sda4
resize2fs /dev/vgubuntu/root

mkdir /mnt/lv-backup
mount /dev/vg-backup/lv-backup /mnt/lv-backup
touch /mnt/lv-backup.txt

pvs
vgs
lvs
```

# Полезная информация
[LVM — ALT Linux Wiki](https://www.altlinux.org/LVM)
[25. Управление логическими томами - LVM — Основы GNU/Linux и подготовка к RHCSA](https://basis.gnulinux.pro/ru/latest/basis/25/25._%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BB%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%BC%D0%B8_%D1%82%D0%BE%D0%BC%D0%B0%D0%BC%D0%B8_-_LVM.html)